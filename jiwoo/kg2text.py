
import torch
from transformers import QuantoConfig, AutoTokenizer, GemmaForCausalLM, LlamaTokenizer, MistralForCausalLM, MistralConfig, LlamaForCausalLM
import os
from tqdm import tqdm
import json

os.environ["CUDA_DEVICE_ORDER"] = "PCI_BUS_ID"
MODEL_NAME ="mistralai/Mistral-7B-Instruct-v0.2"
#MODEL_NAME ="google/gemma-2b-it"
#MODEL_NAME="meta-llama/Llama-2-7b-hf"
tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME,add_eos_token=True)
#config = MistralConfig.from_pretrained(MODEL_NAME)

#tokenizer.pad_token = tokenizer.eos_token
tokenizer.pad_token = tokenizer.unk_token #맞는지 모름
quantization_config = QuantoConfig(weights="int8")
llm=MistralForCausalLM.from_pretrained(MODEL_NAME, load_in_4bit=True,  quantization_config=quantization_config, torch_dtype=torch.bfloat16) #8bit->4bit
with open("/SSL_NAS/jiwoo2nd/subgraph/subgraph/subgraph_list_string.json", "r") as f:
    str_list=json.load(f)

new_str_list=[]
with torch.no_grad():
    templete=("triple set: 'R. Kelly | broadcast.artist.content | 1Club.FM: V101', 'R. Kelly | music.artist.genre | Dance-pop', 'R. Kelly | broadcast.artist.content | SoulfulHipHop.com Radio', 'R. Kelly | people.person.profession | Music executive', 'R. Kelly | music.featured_artist.albums | PYD', 'R. Kelly | music.artist.genre | Contemporary R&B', 'R. Kelly | broadcast.artist.content | radioIO RNB Mix', 'R. Kelly | people.person.profession | Film Producer', 'R. Kelly | people.person.profession | Singer', 'R. Kelly | common.topic.notable_types | Musical Artist', 'R. Kelly | freebase.valuenotation.is_reviewed | Gender', 'R. Kelly | music.artist.genre | Hip hop music', 'R. Kelly | people.person.profession | Musician', 'R. Kelly | music.artist.genre | Rhythm and blues', 'R. Kelly | freebase.valuenotation.is_reviewed | Date of birth', 'R. Kelly | people.person.nationality | United States of America', 'R. Kelly | freebase.valuenotation.is_reviewed | Country of nationality', 'R. Kelly | people.person.profession | Singer-songwriter', 'R. Kelly | freebase.valuenotation.is_reviewed | Place of birth', '1Club.FM: V101 | broadcast.content.artist | R. Kelly', '1Club.FM: V101 | broadcast.content.genre | Contemporary R&B', 'SoulfulHipHop.com Radio | broadcast.content.artist | R. Kelly', 'SoulfulHipHop.com Radio | broadcast.content.genre | Contemporary R&B', 'SoulfulHipHop.com Radio | broadcast.content.genre | Hip hop music', 'PYD | music.album.featured_artists | R. Kelly', 'Contemporary R&B | broadcast.genre.content | 1Club.FM: V101', 'Contemporary R&B | broadcast.genre.content | SoulfulHipHop.com Radio', 'Contemporary R&B | broadcast.genre.content | radioIO RNB Mix', 'Contemporary R&B | music.genre.parent_genre | Rhythm and blues', 'radioIO RNB Mix | broadcast.content.genre | Contemporary R&B', 'radioIO RNB Mix | broadcast.content.genre | Rhythm and blues', 'Singer | people.profession.corresponding_type | Musical Artist', 'Singer | people.profession.specialization_of | Musician', 'Singer | people.profession.specializations | Singer-songwriter', 'Musical Artist | freebase.type_profile.equivalent_topic | Musician', 'Hip hop music | broadcast.genre.content | SoulfulHipHop.com Radio', 'Musician | people.profession.specializations | Singer', 'Musician | freebase.equivalent_topic.equivalent_type | Musical Artist', 'Musician | people.profession.corresponding_type | Musical Artist', 'Musician | people.profession.specializations | Singer-songwriter', 'Rhythm and blues | music.genre.subgenre | Contemporary R&B', 'Rhythm and blues | broadcast.genre.content | radioIO RNB Mix', 'Singer-songwriter | people.profession.specialization_of | Singer', 'Singer-songwriter | people.profession.corresponding_type | Musical Artist', 'Singer-songwriter | people.profession.specialization_of | Musician'\n"
                                    "text: 'R. Kelly, an American musical artist, is known for his work in Dance-pop, Contemporary R&B, Hip hop music, and Rhythm and blues genres. He is a singer, songwriter, musician, music executive, and film producer. His content is broadcast on 1Club.FM: V101, SoulfulHipHop.com Radio, and radioIO RNB Mix. He is a featured artist on the album PYD. Contemporary R&B is a subgenre of Rhythm and blues and is featured on 1Club.FM: V101, SoulfulHipHop.com Radio, and radioIO RNB Mix.'\n\n"
                                    "triple set: 'Gastropolis: Food and New York City | book.written_work.subjects | New York City', 'New York City | book.book_subject.works | Gastropolis: Food and New York City', 'New York City | exhibitions.exhibition_subject.exhibitions_created_about_this_subject | State of the Art: New York', 'New York City | visual_art.art_subject.artwork_on_the_subject | Flags on Fifty-Seventh Street', 'New York City | periodicals.newspaper_circulation_area.newspapers | National Anti-Slavery Standard', 'New York City | book.book_subject.works | Let the Great World Spin', 'New York City | periodicals.newspaper_circulation_area.newspapers | Americada', 'New York City | travel.travel_destination.tourist_attractions | Crocheron Park', 'New York City | book.book_subject.works | What Happened to Anna K.', 'New York City | travel.travel_destination.tourist_attractions | Louis Armstrong House', 'New York City | book.book_subject.works | World Voices Festival Celebrates Literary Diplomacy (part 1 of 2)', 'New York City | media_common.quotation_subject.quotations_about_this_subject | \"History dressed up in the glow of love’s kiss turned grief into beauty.\"', 'New York City | book.book_subject.works | Lush Life: A Novel', 'New York City | periodicals.newspaper_circulation_area.newspapers | The Village Voice', 'New York City | travel.travel_destination.tourist_attractions | UAE Healthy Kidney 10K', 'New York City | location.location.nearby_airports | East 34th Street Heliport', 'New York City | tv.tv_location.tv_shows_filmed_here | The Stand', 'New York City | base.militaryinfiction.location_in_fiction.contained_by | Lemurian windows into any place or time', 'New York City | fictional_universe.fictional_setting.setting_type | Lemurian windows into any place or time', 'New York City | base.militaryinfiction.location_represented_in_fiction.representations | Lemurian windows into any place or time', 'New York City | common.topic.subject_of | Engage the Crowd NYC', 'New York City | film.film_subject.films | The Warriors', 'State of the Art: New York | exhibitions.exhibition.subjects | New York City', 'Flags on Fifty-Seventh Street | visual_art.artwork.art_subject | New York City', 'National Anti-Slavery Standard | book.newspaper.circulation_areas | New York City', 'Let the Great World Spin | book.written_work.subjects | New York City', 'Americada | book.newspaper.circulation_areas | New York City', 'Crocheron Park | travel.tourist_attraction.near_travel_destination | New York City', 'Crocheron Park | location.location.containedby | New York City', 'What Happened to Anna K. | book.written_work.subjects | New York City', 'Louis Armstrong House | travel.tourist_attraction.near_travel_destination | New York City', 'World Voices Festival Celebrates Literary Diplomacy (part 1 of 2) | book.written_work.subjects | New York City', '\"History dressed up in the glow of love’s kiss turned grief into beauty.\" | media_common.quotation.subjects | New York City', 'Lush Life: A Novel | book.written_work.subjects | New York City', 'The Village Voice | book.newspaper.circulation_areas | New York City', 'UAE Healthy Kidney 10K | travel.tourist_attraction.near_travel_destination | New York City', 'East 34th Street Heliport | aviation.airport.serves | New York City', 'The Stand | tv.tv_program.filming_locations | New York City', 'The Stand | film.film.featured_film_locations | New York City', 'Lemurian windows into any place or time | base.militaryinfiction.location_in_fiction.contains | New York City', 'Lemurian windows into any place or time | fictional_universe.type_of_fictional_setting.settings | New York City', 'Lemurian windows into any place or time | base.militaryinfiction.location_in_fiction.representation_of_real_location | New York City', 'Engage the Crowd NYC | common.topic.subjects | New York City', 'The Warriors | film.film.featured_film_locations | New York City', 'The Warriors | film.film.subjects | New York City'\n"
                                    "text:'\"Gastropolis: Food and New York City\" explores the subject of New York City. The State of the Art: New York exhibition was created about New York City, and the artwork Flags on Fifty-Seventh Street features New York City. The National Anti-Slavery Standard, Americada, and The Village Voice newspapers circulate in New York City. The books Let the Great World Spin, What Happened to Anna K., World Voices Festival Celebrates Literary Diplomacy (part 1 of 2), and Lush Life: A Novel all have New York City as a subject. Tourist attractions in New York City include Crocheron Park, Louis Armstrong House, and the UAE Healthy Kidney 10K. The East 34th Street Heliport serves New York City. The TV show The Stand and the film The Warriors were filmed in New York City. The Lemurian windows into any place or time is a fictional setting containing New York City and representing it. Engage the Crowd NYC is a subject about New York City, and a quote, \"History dressed up in the glow of love’s kiss turned grief into beauty,\" is about New York City.'\n\n"
                                    "triple set: 'Joseph G. Aulisi | film.film_costumer_designer.costume_design_for_film | Nobody's Fool', 'Joseph G. Aulisi | people.person.gender | Male', 'Nobody's Fool | film.film.costume_design_by | Joseph G. Aulisi', 'Nobody's Fool | film.film.production_companies | Paramount Pictures', 'Nobody's Fool | film.film.featured_film_locations | Prescott', 'Nobody's Fool | film.film.edited_by | John Bloom', 'Nobody's Fool | film.film.produced_by | Scott Rudin', 'Nobody's Fool | film.film.country | United States of America', 'Nobody's Fool | media_common.netflix_title.netflix_genres | Drama', 'Nobody's Fool | film.film.genre | Drama', 'Nobody's Fool | film.film.written_by | Robert Benton', 'Nobody's Fool | film.film.directed_by | Robert Benton', 'Nobody's Fool | film.film.film_production_design_by | David Gropman', 'Nobody's Fool | film.film.soundtrack | Nobody's Fool', 'Nobody's Fool | film.film.film_festivals | 1995 Berlin International Film Festival', 'Nobody's Fool | film.film.rating | R (USA)', 'Nobody's Fool | media_common.adaptation.adapted_from | Nobody's fool', 'Nobody's Fool | media_common.netflix_title.netflix_genres | Tearjerkers', 'Nobody's Fool | film.film.cinematography | John Bailey', 'Nobody's Fool | common.topic.image | Nobody's Fool', 'Nobody's Fool | film.film.story_by | Richard Russo', 'Nobody's Fool | common.topic.notable_types | Film', 'Prescott | film.film_location.featured_in_films | Nobody's Fool', 'Prescott | location.location.containedby | United States of America', 'John Bloom | film.editor.film | Nobody's Fool', 'John Bloom | people.person.gender | Male', 'Scott Rudin | film.producer.film | Nobody's Fool', 'Scott Rudin | people.person.gender | Male', 'Scott Rudin | people.person.nationality | United States of America', 'Robert Benton | film.director.film | Nobody's Fool', 'Robert Benton | film.writer.film | Nobody's Fool', 'Robert Benton | people.person.gender | Male', 'Robert Benton | people.person.nationality | United States of America', 'David Gropman | film.film_production_designer.films_production_designed | Nobody's Fool', 'David Gropman | people.person.gender | Male', 'David Gropman | people.person.nationality | United States of America', 'R (USA) | film.content_rating.country | United States of America', 'John Bailey | film.cinematographer.film | Nobody's Fool', 'John Bailey | people.person.gender | Male', 'John Bailey | people.person.nationality | United States of America'\n"
                                    "text: 'Joseph G. Aulisi is a male costume designer for the film Nobody's Fool. Nobody's Fool was produced by Scott Rudin, directed by Robert Benton, and written by Robert Benton with a story by Richard Russo. The film was edited by John Bloom and its cinematography was done by John Bailey. The production design was by David Gropman. Nobody's Fool is a drama produced by Paramount Pictures, set in Prescott, and features a soundtrack titled Nobody's Fool. The film was featured in the 1995 Berlin International Film Festival, has an R rating in the United States of America, and is available on Netflix under the genres of drama and tearjerkers. Prescott is located in the United States of America. Scott Rudin, Robert Benton, David Gropman, and John Bailey are all male and of American nationality.'\n\n"
                                    "Instrution: Please generate text from below knowledge triples and don't output any other unrelated sentences. Above are 3 examples:\n"
                                    "triple set: ")
    for i in tqdm(range(len(str_list))):
        chat=templete+str_list[i]+"\n"+"text:"
        messages = [
        {'role': "user", 'content':chat}
        ]
        prompt = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
        inputs = tokenizer(prompt, return_tensors="pt").to(llm.device)
        outputs = llm.generate(**inputs, temperature=0.1, max_new_tokens=500, num_beams=3, early_stopping=True)
        output_text = tokenizer.decode(outputs[0], skip_special_tokens=True)
        if 'text:' in output_text:
            output_text =output_text.split('text:')[-1]
        new_str_list.append(output_text)
        print(output_text,flush=True)

with open("kg2text.json", "w") as f:
    json.dump(new_str_list, f)

